package com.brentcodes.springboot.librarysystem.vulnerability;

import com.brentcodes.springboot.librarysystem.project.Project;
import com.brentcodes.springboot.librarysystem.uservulnerability.UserVulnerability;
import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.Instant;
import java.util.Objects;
import java.util.Set;
import java.util.HashSet;

@Data
@Entity
@Table(name = "vulnerability")
@Builder
@NoArgsConstructor
@AllArgsConstructor
@JsonIgnoreProperties({"hibernateLazyInitializer", "handler"})
public class Vulnerability {
    @Id
    @SequenceGenerator(
            name = "vulnerability_sequence",
            sequenceName = "vulnerability_sequence",
            allocationSize = 1
    )
    @GeneratedValue(
            strategy = GenerationType.SEQUENCE,
            generator = "vulnerability_sequence"
    )
    private Long id;

    @Column(nullable=false)
    private String title;
    @Column(length=4000)
    private String description;

    // Security-first fields
    private String cveId;     // e.g., "CVE-2024-12345" (optional)
    private String cweId;     // e.g., "CWE-79" (optional)

    @Enumerated(EnumType.STRING)
    private Severity severity;

    @Enumerated(EnumType.STRING)
    private VulnStatus status;

    private Instant updatedAt;
    private Instant reportedAt;
    private Instant dueAt;
    private Instant patchedAt;
    private Instant verifiedAt;

    private String repository; // what repo the bug was found in
    private String commitHash; // what git command or etc. caused it

    @Column(columnDefinition = "TEXT")
    private String codeSnippet; // optional vulnerable code snippet
    private String codeLanguage; // e.g. "java", "python", "javascript"

    // üîë Project ‚Üî Vulnerability (many vulnerabilities to one project)
    @ManyToOne(fetch = FetchType.LAZY) // cascade
    @JoinColumn(name = "project_id", nullable = false)
    @JsonIgnore
    private Project project;

    // "Hey, I‚Äôm Vulnerability.java, and I know I‚Äôm related to many UserVulnerbility entries via the vulnerability field in that class."
    // üîë Relationships
    @OneToMany(mappedBy = "vulnerability", cascade = CascadeType.ALL, orphanRemoval = true)
    private Set<UserVulnerability> userVulnerabilities = new HashSet<>();


    // ‚úÖ Used for backend seeding (e.g., in DataInitializer), avoids @Id injection
    // ‚ö†Ô∏è Excludes auto-generated `id`
    // ‚ÑπÔ∏è Holds similar value to Lombok builder but excludes id
    public Vulnerability(String title, String description, String cveId, String cweId, Severity severity,
                         VulnStatus status, Instant updatedAt, Instant reportedAt, Instant dueAt, Instant patchedAt,
                         Instant verifiedAt,
                         String repository, String commitHash, Project project) {
        this.title = title;
        this.description = description; // The rest are in updateVulnerabilityInfo
        this.cveId = cveId;
        this.cweId = cweId;
        this.severity = severity;
        this.status = status; // ‚Üí `transitionStatus(...)` for updates and already included in report
        this.updatedAt = updatedAt; // No custom method: set inside all update methods
        this.reportedAt = reportedAt; // No custom method: set at creation only
        this.dueAt = dueAt;
        this.patchedAt = patchedAt; // ‚Üí `completeAssignment(...)` (ASSIGNEE)
        this.verifiedAt = verifiedAt; // ‚Üí `completeAssignment(...)` (VERIFIER)
        this.repository = repository;
        this.commitHash = commitHash;
        this.project = project;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (!(o instanceof Vulnerability)) return false;
        Vulnerability other = (Vulnerability) o;
        return id != null && id.equals(other.id);
    }

    @Override
    public int hashCode() {
        return Objects.hashCode(id);
    }
}

