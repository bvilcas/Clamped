package com.brentcodes.springboot.librarysystem.uservulnerability;

import com.brentcodes.springboot.librarysystem.user.Role;
import com.brentcodes.springboot.librarysystem.vulnerability.Vulnerability;
import org.springframework.data.domain.Sort;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.transaction.annotation.Transactional;

import java.util.Collection;
import java.util.List;
import java.util.Optional;

// In this order, the repository managed the UserVulnerability table and its primary key is UserVulnerabilityId
// The first parameter is the entity im working with while the other is the primary key the entity uses
public interface UserVulnerabilityRepository extends JpaRepository<UserVulnerability, UserVulnerabilityId> {

    // All of these are implemented for UserVulnerabilityService and that class only
    List<UserVulnerability> findByUserId(@Param("userId") Long userId);

    List<UserVulnerability> findByUserIdAndRole(Long userId, RoleInVuln role);

    Optional<UserVulnerability> findByUserIdAndVulnerabilityId(Long userId, Long vulnId);

    boolean existsByUserIdAndVulnerabilityIdAndRole(Long userId, Long vulnerabilityId, RoleInVuln role);

    boolean existsByVulnerabilityIdAndRole(Long vulnId, RoleInVuln roleInVuln);

    List<UserVulnerability> findByUserIdAndVulnerabilityProjectIdAndRole(Long userId, Long vulnerabilityProjectId, RoleInVuln role);

    @Modifying
    @Transactional
    @Query("""
    DELETE FROM UserVulnerability uv
    WHERE uv.user.id = :userId
      AND uv.vulnerability.project.id = :projectId
""")
    void deleteAllAssignmentsForUserInProject(Long userId, Long projectId);

    @Query("""
    SELECT uv FROM UserVulnerability uv
    JOIN FETCH uv.user
    JOIN FETCH uv.vulnerability
    WHERE uv.vulnerability.project.id = :projectId
""")
    List<UserVulnerability> findByVulnerabilityProjectIdWithUsers(@Param("projectId") Long projectId);
}
