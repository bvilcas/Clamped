package com.brentcodes.springboot.librarysystem.uservulnerability;

import com.brentcodes.springboot.librarysystem.vulnerability.Vulnerability;
import com.brentcodes.springboot.librarysystem.user.User;
import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonManagedReference;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.time.Instant;
import java.util.Objects;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Entity
@Table(name = "user_vulnerability")
public class UserVulnerability {
    // creates composite key, boilerplate
    @EmbeddedId
    private UserVulnerabilityId id = new UserVulnerabilityId();

    // MapsId takes the ID from the student and the ID from the vulnerability, and combine them to create the primary key for this record.
    // This primary key is also called the composite key in this context (merges the two primary/foreign keys)
    // Foreign keys live in the combining table
    @ManyToOne(fetch = FetchType.LAZY)
    @MapsId("userId") // create foreign key
    @JoinColumn(name = "user_id")
    @JsonIgnore
    private User user;

    // @MapsId will generate an embedded ID, no need for sequence generation or instantiation in constructor
    @ManyToOne(fetch = FetchType.LAZY)
    @MapsId("vulnerabilityId") // boilerplate, references the UserVulnerabilityId composite create
    @JoinColumn(name = "vulnerability_id")
    @JsonIgnore
    private Vulnerability vulnerability;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private RoleInVuln role; // REPORTER, ASSIGNEE, VERIFIER

    @Column(nullable = false)
    private Instant assignedAt;

    private boolean selfAssigned;

    private Instant completedAt; // When it is verified and everything else is done (implied)

    // Only for seeding (without id)
    public UserVulnerability(User user, Vulnerability vulnerability, RoleInVuln role,
                             Instant assignedAt, boolean selfAssigned, Instant completedAt) {
        this.user = user;
        this.vulnerability = vulnerability;
        this.role = role;
        this.assignedAt = assignedAt;
        this.selfAssigned = selfAssigned;
        this.completedAt = completedAt;
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (!(o instanceof UserVulnerability)) return false;
        UserVulnerability other = (UserVulnerability) o;
        return id != null && id.equals(other.id);
    }

    @Override
    public int hashCode() {
        return Objects.hashCode(id);
    }
}

